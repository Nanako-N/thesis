<!--
    地図上に最適な目的地、周辺情報を表示するページ
  -->
{% extends 'blog/base.html' %}
{% load static %}

{% block content %}
<p>
  <a href="{% url 'add_route' group.pk %}">追加</a>
</p>

<p>
  グループ番号: {{ group.pk }}<br>
  目的地: {{ landmark }}<br>
  最適な待ち合わせ場所： {{ meet.0 }}<br>
</p>

<p>
  {% for r in route %}
  路線: {{ r }} <br>
  {% endfor %}
</p>

<table width="800">
     <tr>
         <th><p class="maru1"></p>:西武新宿駅</th> 　　　
         <th><p class="maru2"></p>:都営大江戸線　新宿西口駅</th>
         <th><p class="maru5"></p>:都営大江戸線　新宿駅</th>
     </tr>
     <tr>
         <th><p class="maru9"></p>:副都心線　新宿三丁目駅</th>
         <th><p class="maru3"></p>:丸ノ内線　新宿駅</th>　
         <th><p class="maru6"></p>:丸ノ内線　新宿三丁目駅</th>
     </tr>
     <tr>
         <th><p class="maru7"></p>:都営新宿線　新宿駅</th>
         <th><p class="maru8"></p>:都営新宿線　新宿三丁目駅</th>
         <th><p class="maru4"></p>:JR線　新宿駅</th>
     </tr>
     <tr>
         <th><p class="maru10"></p>:京王線　新宿駅</th>
         <th><p class="maru11"></p>:京王新線　新宿駅</th>　
         <th><p class="maru12"></p>:小田急線　新宿駅</th>
     </tr>
 </table>
 <br>

<img src="{% static "img/gate.png"%}"/ style="padding-bottom: 2px">:改札　　
<img src="{% static "img/stairs.png"%}"/ style="padding-bottom: 2px"> :階段　　
<img src="{% static "img/escalator.png"%}"/ style="padding-bottom: 2px"> :エスカレーター　
<img src="{% static "img/elevator.png"%}"/ style="padding-bottom: 2px"> :エレベーター　
<img src="{% static "img/police.png"%}"/ style="padding-bottom: 2px"> :警察　
<br><br>

<style>
  .maru1{
   vertical-align: bottom;
   display: inline-block;
   width: 22px;
   height: 22px;
   border-radius: 22px;
   margin: 2px;
   background-color: #58BCF2;
  }
   .maru2{
    display: inline-block;
    vertical-align: bottom;
    width: 22px;
    height: 22px;
    border-radius: 22px;
    margin: 2px;
    background-color: #F1ABE1;
  }
   .maru3{
    display: inline-block;
    vertical-align: bottom;
    width: 22px;
    height: 22px;
    border-radius: 22px;
    margin: 2px;
    background-color: #EB412C;
  }
   .maru4{
    display: inline-block;
    vertical-align: bottom;
    width: 22px;
    height: 22px;
    border-radius: 22px;
    margin: 2px;
    background-color: #ED7D32;
  }
   .maru5{
    display: inline-block;
    vertical-align: bottom;
    vertical-align: bottom;
    width: 22px;
    height: 22px;
    border-radius: 22px;
    margin: 2px;
    background-color: #E95DFA;
  }
  .maru6{
   display: inline-block;
   vertical-align: bottom;
   width: 22px;
   height: 22px;
   border-radius: 22px;
   margin: 2px;
   background-color: #EE7B77;
  }
  .maru7{
   display: inline-block;
   vertical-align: bottom;
   width: 22px;
   height: 22px;
   border-radius: 22px;
   margin: 2px;
    background-color: #54B151;
  }
  .maru8{
   display: inline-block;
   vertical-align: bottom;
   width: 22px;
   height: 22px;
   border-radius: 22px;
   margin: 2px;
   background-color: #9CF33E;
  }
  .maru9{
   display: inline-block;
   vertical-align: bottom;
   width: 22px;
   height: 22px;
   border-radius: 22px;
   margin: 2px;
   background-color: #F6C03E;
  }
  .maru10{
   display: inline-block;
   vertical-align: bottom;
   width: 22px;
   height: 22px;
   border-radius: 22px;
   margin: 2px;
   background-color: #C13422;
  }
  .maru11{
   display: inline-block;
   vertical-align: bottom;
   width: 22px;
   height: 22px;
   border-radius: 22px;
   margin: 2px;
   background-color: #942618;
  }
  .maru12{
   display: inline-block;
   vertical-align: bottom;
   width: 22px;
   height: 22px;
   border-radius: 22px;
   margin: 2px;
   background-color: #964FF8;
  }
  .line{
  display: inline-block;
  vertical-align: bottom;
</style>

{% if meet.0 != meet.1 %}
<p>
  <button type="button" onclick="changeMeetPoint(1)" style="width:100px;height:80px"><font size="5">案1</font></button>
  <button type="button" onclick="changeMeetPoint(2)" style="width:100px;height:80px"><font size="5">案2</font></button>
</p>
{% endif %}

<p>
  <button type="button" onclick="changeLayer('/1F')" style="width:100px;height:80px"><font size="5">地上階</font></button>
  <button type="button" onclick="changeLayer('/B1')" style="width:100px;height:80px"><font size="5">B1</font></button>
  <button type="button" onclick="changeLayer('/B2')" style="width:100px;height:80px"><font size="5">B2</font></button>
  <button type="button" onclick="changeLayer('/B3')" style="width:100px;height:80px"><font size="5">B3</font></button>
</p>



<div id="mapcontainer" style="width:900px;height:900px"></div>
<script>

/*----------地図表示---------*/
  var map = L.map("mapcontainer", {
  crs: L.CRS.Simple,
  minZoom: 0,
  maxZoom: 2,
  });

  map.on('click', function(e) {
  alert(e.latlng);
  });

  //地図の中心座標とズームレベルを指定。
  //0が最小、2が最大ズーム
  map.setView(L.latLng(-1000/2, 1000/2), 0);

  //地図に表示するマーカー
  var imgsrc = "<img src='{% static 'img/' %}seira.jpg' width='120' height='150'>";
  var popup1 = L.popup({ maxWidth:300,maxHeight:500 }).setContent(imgsrc);
  var marker = L.marker([-128,128], {title: "クリックで画像表示"}).addTo(map).bindPopup(popup1);

  //地図を表示。(画像がある場所のパスを指定しています。この通りでないと表示できないので注意。)
  tile = L.tileLayer("{% static 'nodemap2' %}" + "/1F/{z}/{x}/{y}.png", {
    tileSize: 1000,
    attribution: "<a>自作タイル</a>",
  }).addTo(map);



  /*地図上にある任意のノードにピンを打つ処理*/

  //マーカーを階層別にグループわけする。1F~B3のノードとother(改札)
  var markerList_all = L.featureGroup();
  var markerList_idea1 = L.featureGroup();
  var markerList_idea2 = L.featureGroup();


//-----マーカー用画像の指定-----
  var blueIcon = L.icon({
    iconUrl: "{% static 'img' %}" + '/blue.png',
    iconSize: [34,55],
    iconAnchor: [17,55],
    iconRetinaUrl: "{% static 'img' %}" + '/blue_2x.png',
  });

  var greenIcon = L.icon({
    iconUrl: "{% static 'img' %}" + '/greenIcon.png',
    iconSize: [25,41],
    iconAnchor: [12.5,41],
    iconRetinaUrl: "{% static 'img' %}" + '/greenIcon_2x.png',
  });

  var redIcon = L.icon({
    iconUrl: "{% static 'img' %}" + '/redIcon.png',
    iconSize: [25,41],
    iconAnchor: [12.5,41],
    iconRetinaUrl: "{% static 'img' %}" + '/redIcon_2x.png',
  });

  var purpleIcon = L.icon({
    iconUrl: "{% static 'img' %}" + '/purpleIcon.png',
    iconSize: [25,41],
    iconAnchor: [12.5,41],
    iconRetinaUrl: "{% static 'img' %}" + '/purpleIcon_2x.png',
  });

  var yellowIcon = L.icon({
    iconUrl: "{% static 'img' %}" + '/yellowIcon.png',
    iconSize: [25,41],
    iconAnchor: [12.5, 41],
    iconRetinaUrl: "{% static 'img' %}" + '/yellowIcon_2x.png',
  });

  var hereIcon = L.icon({
    iconUrl: "{% static 'img' %}" + '/hereIcon.png',
    iconSize: [60,95],
    iconAnchor: [30,95],
    iconRetinaUrl: "{% static 'img' %}" + '/hereIcon_2x.png',
  });



  //全ノード番号と座標データを格納するリスト
  var result = [];
  var markList1 = [];
  var markList2 =[];
  var idx = 0;

  markList1 = {{ meet.0 }};
  markList2 = {{ meet.1 }};


  function getCSV(){
      var req = new XMLHttpRequest(); // HTTPでファイルを読み込むためのXMLHttpRrequestオブジェクトを生成
      req.open("get", "{% static 'nodemap2' %}" + "/nodenumber.csv", true); // アクセスするファイルを指定
      req.send(null); // HTTPリクエストの発行

      // レスポンスが返ってきたらconvertCSVtoArray()を呼ぶ
      req.onload = function(){
  	     convertCSVtoArray(req.responseText); // 渡されるのは読み込んだCSVデータ
      }
  }

var test = 0;
  function convertCSVtoArray(str){ // 読み込んだCSVデータが文字列として渡される
    var tmp = str.split("\n"); // 改行を区切り文字として行を要素とした配列を生成

    // 各行ごとにカンマで区切った文字列を要素とした二次元配列を生成

    for(var i=0;i<tmp.length;++i){
        result[i] = tmp[i].split(',');

        switch (result[i][3] - 0) {
          case 0:
            {% for r in routes %}
              if (result[i][0] == {{ r.route }} -0) {
                markerList_idea1.addLayer(L.marker([result[i][1], result[i][2]], {icon: blueIcon}).bindPopup({{ r.route }}));
                markerList_idea2.addLayer(L.marker([result[i][1], result[i][2]], {icon: blueIcon}).bindPopup({{ r.route }}));
                break;
              }
            {% endfor %}
            break;

          case 1:
            search_and_add(i);
            //markerList_all.addLayer(L.marker([result[i][1], result[i][2]], {title: result[i][0], icon: orangeIcon}).bindPopup(result[i][0]));
            break;

          case 2:
            search_and_add(i);
            //markerList_all.addLayer(L.marker([result[i][1], result[i][2]]).bindPopup(result[i][0]));
            break;

          case 3:
            search_and_add(i);
            //markerList_all.addLayer(L.marker([result[i][1], result[i][2]], {title: result[i][0], icon: greenIcon}).bindPopup(result[i][0]));
            break;

          case 4:
            search_and_add(i);
            //markerList_all.addLayer(L.marker([result[i][1], result[i][2]], {title: result[i][0], icon: greenIcon}).bindPopup(result[i][0]));
            break;

          default:
            markerList_all.addLayer(L.marker([result[i][1], result[i][2]], {title: result[i][0]}).bindPopup(result[i][0]));
            break;
        }
    }
  }


  function search_and_add(i) {
    for (var a=0; a<markList1.length; a++) {
      if (result[i][0] == markList1[a]) {
        markerList_idea1.addLayer(L.marker([result[i][1], result[i][2]], {icon: hereIcon}).bindPopup(result[i][0]));
        break;
      }
    }
    for (var a=0; a<markList2.length; a++) {
      if (result[i][0] == markList2[a]) {
        markerList_idea2.addLayer(L.marker([result[i][1], result[i][2]], {icon: hereIcon}).bindPopup(result[i][0]));
        break;
      }
    }
  }

  //上記の関数を読み込んだ後でgetCSV関数を呼び出して処理実行。
  getCSV();

  map.addLayer(markerList_idea1.openPopup());
  //map.addLayer(markerList_idea2.openPopup());

  //タイル差し替え関数
  function changeLayer(place) {
    tile.setUrl("{% static 'nodemap2' %}" + place + "/{z}/{x}/{y}.png");
  }

  function changeMeetPoint(number) {
    if (number == 1) {
      map.addLayer(markerList_idea1.openPopup());
      map.removeLayer(markerList_idea2);
    } else if (number == 2) {
      map.addLayer(markerList_idea2.openPopup());
      map.removeLayer(markerList_idea1);
    }
  }

</script>
{% endblock %}
